define ("block_sharing_cart/script",["jquery","core/modal_factory","core/modal_events"],function(a,b,c){return{init:function init(d){a(document).ready(function(){function f(a){return M.str.block_sharing_cart[a]||M.str.moodle[a]}function g(a,b){var c=M.cfg.wwwroot+"/blocks/sharing_cart/"+a+".php";if(b){var d=[];for(var e in b){d.push(e+"="+encodeURIComponent(b[e]))}c+="?"+d.join("&")}return c}function h(d){if(d.checkbox){d.body+="<div class=\"modal-checbox-wrapper\"><input type=\"checkbox\" id=\"modal-checkbox\" class=\"modal-checkbox\" checked><label for=\"modal-checkbox\">"+f("modal_checkbox")+"</label></div>"}b.create({type:b.types.SAVE_CANCEL,title:d.title,body:d.body}).done(function(b){b.setSaveButtonText(d.save_button);b.getRoot().on(c.save,function(b){var c={checkbox:a(b.target).find(".modal-checkbox").is(":checked")};d.next(c)});b.getRoot().on(c.hidden,function(){a("body").removeClass("modal-open")});b.show()})}function i(a){var b="",c=a.find("h3.sectionname .inplaceeditable");if(c.length){b=c.data("value")}return b}function j(b,c,d,e){(function(c){a.post(g("rest"),b,function(a){c(a)},"text").fail(function(a){k(a)})})(function(a){var g=!1;if("1"===a){g=!0}h({title:c,body:d,save_button:f("modal_confirm_backup"),checkbox:g,next:function next(a){if(!0===e){t(b.sectionid,b.sectionnumber,b.courseid,a.checkbox)}else{s(b.cmid,a.checkbox)}}})})}var u={backup:{css:"editing_backup",iconClass:"fa fa-frown-o",mustEdit:!1},movedir:{css:"editing_right",iconClass:"fa fa-arrow-right",mustEdit:!1},move:{css:"editing_move_",iconClass:"fa fa-arrows-v",mustEdit:!1},edit:{css:"editing_update",iconClass:"fa fa-pencil",mustEdit:!1},cancel:{css:"editing_cancel",iconClass:"fa fa-ban",mustEdit:!1},delete:{css:"editing_update",iconClass:"fa fa-trash",mustEdit:!1},restore:{css:"editing_restore",iconClass:"fa fa-clone",mustEdit:!0},"dir-open":{iconClass:"fa fa-folder-open-o",mustEdit:!1},"dir-closed":{iconClass:"fa fa-folder-o",mustEdit:!1}},v=a(".block_sharing_cart"),w=new function(){var b=a("body");this.id=b.attr("class").match(/course-(\d+)/)[1];this.is_frontpage=b.hasClass("pagelayout-frontpage")};function k(a){try{var b=JSON.parse(a.responseText);new M.core.exception({name:f("pluginname")+" - "+f("error"),message:b.message})}catch(b){new M.core.exception({name:f("pluginname")+" - "+f("error"),message:a.responseText})}}function l(){var a=v.find(".menubar .dropdown .dropdown-menu");return a.length}function m(a,b,c){var e=new Date;e.setTime(e.getTime()+c);var d="expires="+e.toUTCString();document.cookie=a+"="+b+";"+d+""}function n(a){var b=document.cookie.match("(^|;)\\s*"+a+"\\s*=\\s*([^;]+)");return b?b.pop():""}function o(b){var c=a("<i/>").attr("alt",f(b)).attr("class",u[b].iconClass);return a("<a href=\"javascript:void(0)\"/>").addClass(u[b].css).attr("title",f(b)).append(c)}function p(){var b=a("<div class=\"block_spinner\"><i class=\"fa fa-circle-o-notch fa-spin fa-2x\"></i></div>");a("section.block_sharing_cart").append(b);return b}function q(b){var c=a("<i class=\"fa fa-circle-o-notch fa-spin node_spinner\"></i>");b.append(c);return c}a(document).on("click","a.restore",function(){p()});function r(){a.post(g("rest"),{action:"render_tree",courseid:w.id},function(b){v.find(".tree").replaceWith(a(b));a.init_item_tree()},"html").fail(function(a){k(a)})}function s(b,c){var d=a("#module-"+b+" .actions");if(!d.length){d=a("[data-owner=\"#module-"+b+"\"]")}var e=p(),f=q(d);a.post(g("rest"),{action:"backup",cmid:b,userdata:c,sesskey:M.cfg.sesskey,courseid:w.id},function(){r()}).fail(function(a){k(a)}).always(function(){f.hide();e.hide()})}function t(b,c,d,e){var f=a("span.inplaceeditable[data-itemtype=sectionname][data-itemid="+b+"]"),h=f.closest("li.section.main"),j=h.attr("aria-label");if(null===j){j=a("#region-main .section_action_menu[data-sectionid='"+b+"']").parent().parent().find("h3.sectionname").text()+""}var l=i(h);j=""!==l?l:j;var m=p(),n=q(f);a.post(g("rest"),{action:"backup_section",sectionid:b,sectionnumber:c,courseid:d,sectionname:j,userdata:e,sesskey:M.cfg.sesskey},function(){r()}).fail(function(a){k(a)}).always(function(){m.hide();n.hide()})}var x=new function(){var f=n("block_sharing_cart-dirs").split(",").map(function(a){return parseInt(a)});function b(){var a=new Date;a.setDate(a.getDate()+30);m("block_sharing_cart-dirs",f.join(","),a)}function c(a,b){var c=b?"dir-open":"dir-closed",d=u[c].iconClass;a.find("> div i.icon").attr("class","icon "+d);a.find("> ul.list")[b?"show":"hide"]()}function d(d){var e=a(d.target).closest("li.directory"),g=e.attr("id").match(/(\d+)$/)[1],h="none"===e.find("> ul.list").css("display");c(e,h);f[g]=h?1:0;b()}this.init=function(){var b=0;v.find("li.directory").each(function(e,g){var h=a(g);h.attr("id","block_sharing_cart-dir-"+b);if(b>=f.length){f.push(0)}else if(f[b]){c(h,!0)}h.find("> div div.toggle-wrapper").css("cursor","pointer").on("click",function(a){d(a)});b++})};this.reset=function(){f=[];this.init();b()}},y=new function(){var b=null,c=[];this.hide=function(){if(null!==b){var d=b.closest(".commands");b.remove();b=null;d.closest("li.activity").css("opacity",1);d.find("a").each(function(){a(this).show()});a.each(c,function(a,b){b.remove()});c=[]}};this.show=function(d){this.hide();function h(b){var c=a(b.target).closest("a").attr("class").match(/move-(\d+)-to-(\d+)/),d=c[1],e=c[2],f=p();a.post(g("rest"),{action:"move",item_id:d,area_to:e,sesskey:M.cfg.sesskey},function(){r()}).fail(function(a){k(a)}).always(function(){f.hide()})}var j=v.find("#block_sharing_cart-item-"+d),l=j.next(),m=j.closest("ul"),n=0;if(l.length){n=l.attr("id").match(/item-(\d+)$/)[1]}function i(b,c){var d=a("<a href=\"javascript:void(0)\"/>").addClass("move-"+b+"-to-"+c).attr("title",f("movehere")).append(a("<p>"+f("clicktomove")+"</p>").attr("alt",f("movehere"))),e=a("<li class=\"activity move-to\"/>").append(d);d.on("click",function(a){h(a)});return e}m.find("> li.activity").each(function(e,f){var g=a(f),h=g.attr("id").match(/item-(\d+)$/)[1];if(h===d){b=o("cancel","t/left");b.on("click",function(){y.hide()});var j=g.find(".commands");j.find("a").each(function(){a(this).hide()});j.append(b);g.css("opacity",.5)}else if(h!==n){var k=i(d,h);g.before(k);c.push(k)}},this);if(l){var q=i(d,0);m.append(q);c.push(q)}}},z=new function(){this.is_directory=null;var c=null,d=[];function b(b,c){var e="",h=a("#copy-section-form").data("in-section");if(z.is_directory){e=g("restore",{directory:!0,path:b,course:w.id,section:c,in_section:h,sesskey:M.cfg.sesskey})}else{e=g("restore",{directory:!1,id:b,course:w.id,section:c,in_section:h,sesskey:M.cfg.sesskey})}var i=a("<a/>").attr("class","restore").attr("href",e).attr("title",f("copyhere")).append(a("<img class=\"move_target\"/>").attr("alt",f("copyhere")).attr("src",M.util.image_url("dropzone_arrow","block_sharing_cart")));d.push(i);return i}this.hide=function(){if(null!==c){c.remove();c=null;a.each(d,function(a,b){b.remove()});d=[]}};this.show=function(d){this.hide();var e=a("<span/>");if(this.is_directory){e.html(d).css("display","inline");e.prepend(a("<i/>").addClass("icon").attr("alt",d))}else{var g=v.find("#block_sharing_cart-item-"+d);e=a(g.find("div")[0].cloneNode(!0)).css("display","inline");e.attr("class",e.attr("class").replace(/mod-indent-\d+/,""));e.find(".commands").remove()}var h=o("cancel");h.on("click",this.hide);c=a("<div class=\"clipboard\"/>");c.append(f("clipboard")+": ").append(e).append(h);if(w.is_frontpage){var i=a(".sitetopic"),j=a(".block_site_main_menu");if(i){i.find("*").before(c)}else if(j){j.find(".content").before(c)}if(j){j.find(".footer").before(b(d,0))}if(i){i.find("ul.section").append(b(d,1))}}else{var k=a(".course-content");k.prepend(c);k.find(M.course.format.get_section_wrapper(null)).each(function(c,e){var f=a(e),g=f.attr("id").match(/(\d+)$/)[1];f.find("ul.section").first().append(b(d,g))},this)}}};a.get_plugin_name=function(){var a=v.find("h2");if(!a.length){a=v.find("h3");if(a.length){return a.html()}}else{return a.html()}return""};a.on_backup=function(b,c){var d=function(a){var b=a.closest("li.activity");if(b.length){return b.attr("id").match(/(\d+)$/)[1]}var c=a.closest(".commands"),d=c.attr("data-owner");if(d.length){return d.match(/(\d+)$/)[1]}return c.find("a.editing_delete").attr("href").match(/delete=(\d+)/)[1]}(a(b.target));j({action:"is_userdata_copyable",cmid:d},c,f("confirm_backup"),!1)};a.on_movedir=function(b){var d=a(b.target).closest(".commands"),e=d.closest("li.directory"),f=e.length?e.attr("directory-path"):"/",h=a(b.target).closest("li.activity").attr("id").match(/(\d+)$/)[1],j=[];v.find("li.directory").each(function(){j.push(a(this).attr("directory-path"))});var l=a("<form/>");l.attr("action","javascript:void(0)");function c(){var b=l.find("[name=\"to\"]").val(),c=p();a.post(g("rest"),{action:"movedir",item_id:h,folder_to:b,sesskey:M.cfg.sesskey},function(){r();x.reset()}).fail(function(a){k(a)}).always(function(){c.hide()})}l.submit(c);if(0===j.length){var m=a("<input class=\"form-control\" type=\"text\" name=\"to\"/>").val(f);setTimeout(function(){m.focus()},1);l.append(m)}else{j.unshift("/");for(var n=a("<select class=\"custom-select\" name=\"to\"/>"),q=0;q<j.length;q++){n.append(a("<option/>").val(j[q]).append(j[q]))}n.val(f);n.change(c);l.append(n);var s=o("edit");s.on("click",function(){var b=a("<input type=\"text\" name=\"to\"/>").val(f);n.remove();s.replaceWith(b);b.focus()});l.append(s)}var t=o("cancel");t.on("click",function(){l.remove();d.find("a").show()});l.append(t);d.find("a").each(function(){a(this).hide()});d.append(l)};a.on_move=function(b){var c=a(b.target).closest("li.activity"),d=c.attr("id").match(/(\d+)$/)[1];y.show(d)};a.on_delete=function(b){var c=a(b.target).closest("li"),d=c[0].innerText,e=!1,i,j,l="";if(c.hasClass("directory")){e=!0;j=f("folder_string");l=f("delete_folder")}else{j=f("activity_string")}i="<p class=\"delete-item\">"+j+" "+d+l+"</p>";h({title:f("confirm_delete"),body:i,save_button:f("modal_confirm_delete"),checkbox:!1,next:function next(){var d={};if(!0===e){d={action:"delete_directory",path:c.attr("directory-path"),sesskey:M.cfg.sesskey}}else if(c.hasClass("activity")){d={action:"delete",id:c.attr("id").match(/(\d+)$/)[1],sesskey:M.cfg.sesskey}}var f=p();a.post(g("rest"),d,function(){r()}).fail(function(a){k(a)}).always(function(){f.hide()});b.stopPropagation()}})};a.on_restore=function(b){var c=a(b.target).closest("li"),d=null;if(c.hasClass("directory")){d=c.attr("directory-path");z.is_directory=!0}else if(c.hasClass("activity")){d=c.attr("id").match(/(\d+)$/)[1];z.is_directory=!1}z.show(d)};a.on_section_backup=function(a,b,c,d){var e="<p class=\"alert alert-danger mt-3\">"+f("backup_heavy_load_warning_message")+"</p>"+f("confirm_backup_section");j({action:"is_userdata_copyable_section",sectionid:a,sectionnumber:b,courseid:c},d,e,!0)};a.init_bulk_delete=function(b){var c=v.find(".editing_bulkdelete");if(c.length){if(b){c.attr("role","menuitem").addClass("dropdown-item menu-action");c.append(a("<span class='menu-action-text'/>").append(c.attr("title")));v.find(".menubar .dropdown .dropdown-menu").append(c)}else{v.find(".header .commands").append(c)}}};a.init_help_icon=function(a){var b=v.find(".header-commands > .help-icon");if(a){v.find(".header-commands").parent().css("display","block")}else{v.find(".header .commands").append(b)}};a.init_block_header=function(){var b=l();a.init_bulk_delete(b);a.init_help_icon(b)};a.init_item_tree=function(){function b(b,c){var e=a(b),f=e.find(".commands").first();a.each(c,function(b,c){if(!u[c].mustEdit||d){var e=o(c);e.on("click",function(b){a["on_"+c](b)});f.append(e)}},this)}var c=["movedir","move","delete"];if(w){c.push("restore")}var e=["delete","restore"];v.find("li.activity").each(function(d,e){if(1==a(e).attr("data-disable-copy")){b(e,["movedir","move","delete"]);return}b(e,c)});v.find("li.directory").each(function(a,c){b(c,e)});x.init()};a.init_activity_commands=function(){a(document).ajaxComplete(function(b,d,e){var f=e.url,g=f.lastIndexOf("="),h=f.substring(g+1);if("core_course_edit_module"===h||"core_course_get_module"===h){var i=JSON.parse(e.data),j=i[0].args.action;if("delete"===j){return}setTimeout(function(){var b=i[0].args.id,d=a("#module-"+b);c(d);if("duplicate"===j){var e=d.next();c(e)}},1)}});function b(){var b=a("<a href=\"javascript:void(0)\" class=\"add-to-sharing-cart\" />").append(a("<i class=\"fa fa-shopping-basket icon\"></i>")).attr("title",f("backup"));return b}function c(c){var d=c[0].className,e=d.substr(d.indexOf("modtype_")+8),g=f("activity_string");if("label"!==e){g=a(".activity#"+c[0].id).find(".mod-indent-outer .activityinstance span.instancename").html()}var h=b();h.on("click",function(b){a.on_backup(b,g)});var i=c.find(".action-menu.section-cm-edit-actions").parent(".actions");i.append(h)}function d(d){var e=d.find(".section_action_menu").data("sectionid"),f=parseInt((d.attr("id")+"").match(/\d+/)[0]),g=d.attr("aria-label"),h=a("body[id$=flexsections]").length;if(h&&("undefined"==typeof e||null===e)){e=d.data("section-id")}var j=parseInt((a("body").attr("class")+"").match(/course-([0-9]*)( |$)/)[1]),k=b();k.on("click",function(){var b=i(d);g=""!==b?b:g;a.on_section_backup(e,f,j,g)});var l=d.find("h3.sectionname").first().find("a").last(),m=d.find("h3.sectionname .inplaceeditable").first();if(m.length){l=m}if(h&&0===f){l=d.find("> .controls");l.prepend(k)}else{k.insertAfter(l)}var n="li.activity";if(h){n="li.activity.activity-section-"+e}var o=d.find(n);a(o).each(function(){c(a(this))})}a("body.editing .course-content li.section").each(function(){d(a(this))})};a.init=function(){M.str.block_sharing_cart.pluginname=this.get_plugin_name();a.init_block_header();a.init_item_tree();a.init_activity_commands()};var A=a("<i/>").addClass("spinner fa fa-3x fa-circle-o-notch fa-spin");a("div#sharing-cart-spinner-modal div.spinner-container").prepend(A);a.init()});a(".copy_section").on("click",function(){var b=a(".section-dropdown option:selected"),c=b.data("section-id"),d=b.data("section-number"),e=b.data("course-id"),f=b.data("section-name");a.on_section_backup(c,d,e,f)})}}});
//# sourceMappingURL=script.min.js.map
